<div>
<button id="compilebtn">Compile</button>
<div id="out" style="display:inline-block">loading yaml...</div>
</div>
<textarea id="yaml" style="width: 45vw; height: 90vh;">Just a sec - retrieving your stuff.
If anything goes wrong, it'll console.error.</textarea>
<iframe id="output" style="width: 45vw; height: 90vh;">Your browser does not support iframes. :'(</iframe>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js">/*$*/</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.6.1/js-yaml.min.js">/*jsyaml*/</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sass.js/0.9.12/sass.min.js">/*Sass*/</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js">/*Handlebars*/</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js">/*marked*/</script>
<script src="bundle.js"></script>
<script>
function out(text, disposition = 0){
  if(disposition > 0) $("#out").css({color:'green'});
  else if(disposition < 0) $("#out").css({color:'red'});
  else $("#out").css({color:'darkyellow'});
  $("#out").text(text);
}

function recompile(){
  var iframe = document.getElementById('output');
  return new Promise(function(resolve,reject){
    out('compiling html...', 0);
    compileYAML($('#yaml').val(), function(html){
      iframe.src = 'about:blank';
      iframe.onload = function(){
        iframe.contentDocument.write(html);
        out('compiled html', 1);
        resolve();
      };
    });
  }).catch(function(e){
    out('Error.', -1);
    console.error(e.stack);
  });
}

$.get('https://cdnjs.cloudflare.com/ajax/libs/sass.js/0.9.12/sass.worker.min.js', function(data){
  var bloburl = window.URL.createObjectURL(new Blob([data], {type: 'text/javascript'}))
  window.sass = new Sass(bloburl);
  
  $.get('content/clive.yml', function(data){
    $("#yaml").val(data);
    recompile();
  });
  
  $('#compilebtn').click(recompile);
  
  //0.5sec cooldown between compiles
  var cooldownActive = false;
  var calledDuringCooldown = false; //but if it's called during the cooldown make sure to call it right away
  
  var oldVal;
  $('#yaml').on('change textInput input', function(){
    if (this.value == oldVal) return;
    else oldVal = this.value;
    
    if(cooldownActive) return calledDuringCooldown = true;
    else cooldownActive = true;
    
    recompile().then(function(){
      setTimeout(function(){
        cooldownActive = false;
        if(calledDuringCooldown) recompile();
        calledDuringCooldown = false;
      }, 500);
    });
  });
});
</script>
